<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录生活点滴"><title>Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability | 菜鸟の日常</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/MyBlog/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/MyBlog/favicon.ico"><link rel="apple-touch-icon" href="/MyBlog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/MyBlog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability</h1><a id="logo" href="/MyBlog/.">菜鸟の日常</a><p class="description">呆到深处自然萌~</p></div><div id="nav-menu"><a href="/MyBlog/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/MyBlog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/MyBlog/about/"><i class="fa fa-user"> 关于</i></a><a href="/MyBlog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability</h1><div class="post-meta">Jan 14, 2017<span> | </span><span class="category"><a href="/MyBlog/categories/漏洞分析/">漏洞分析</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability"><span class="toc-number">1.</span> <span class="toc-text">Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">1.1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Software-and-Environments"><span class="toc-number">1.2.</span> <span class="toc-text">Software and Environments</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reproducing"><span class="toc-number">1.3.</span> <span class="toc-text">Reproducing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exception"><span class="toc-number">1.4.</span> <span class="toc-text">Exception</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">1.5.</span> <span class="toc-text">Analysis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC-file"><span class="toc-number">1.6.</span> <span class="toc-text">PoC file:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch-recommendation"><span class="toc-number">1.7.</span> <span class="toc-text">Patch recommendation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">1.8.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Author"><span class="toc-number">1.9.</span> <span class="toc-text">Author</span></a></li></ol></li></ol></div></div><div class="post-content"><h1 id="Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability"><a href="#Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability" class="headerlink" title="Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability"></a>Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability</h1><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>I have found a vulnerability when I fuzzed libbpg-0.9.7 using the fuzzer which developed by myself. The vulnerability is a heap buffer overflow due to missing check the index value of a heap buffer in BPG decoder. The vulnerability happens when decodes the BPG image. But I am not sure whether it can cause Arbitrary-Code-Execution, maybe it can in some use cases.</p>
<h2 id="Software-and-Environments"><a href="#Software-and-Environments" class="headerlink" title="Software and Environments"></a>Software and Environments</h2><p>Software: libbpg-0.9.7(<a href="http://bellard.org/bpg/" target="_blank" rel="external">http://bellard.org/bpg/</a>)<br>        (download from: <a href="http://bellard.org/bpg/libbpg-0.9.7.tar.gz" target="_blank" rel="external">http://bellard.org/bpg/libbpg-0.9.7.tar.gz</a>)<br>        Operating System: Ubuntu 16.04 i686 Desktop<br>        <img src="/MyBlog/2017/01/14/Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability/14974388511331.jpg" alt=""></p>
<pre><code>Compilers: Clang
![](media/14974388638431.jpg)
</code></pre><h2 id="Reproducing"><a href="#Reproducing" class="headerlink" title="Reproducing"></a>Reproducing</h2><pre><code><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> <span class="keyword">to</span> /* path of libbpg <span class="keyword">source</span> code*/</div><div class="line"><span class="keyword">make</span> –<span class="keyword">j</span></div><div class="line">./bpgdec /*full path of PoC <span class="keyword">file</span>*/</div></pre></td></tr></table></figure>
</code></pre><h2 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h2><pre><code>Parsing the PoC file with the bpgdec compiled by Clang.
![](media/14974389101826.jpg)
</code></pre><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><pre><code>    The vulnerability is caused when decoding BPG image, which happens in function ../libbpg/libbpg.c: build_msps(...).
    Using rr to debug it and printing backtrace infomation.
    ![](media/14974389238646.jpg)

    The crash happens at line 256, libbpg.c. And the heap buffer named “buf”overflows. At the same time, the data of msps_buf is come from input file which user can control its contents.
    ![](media/14974390019566.jpg)

    set a breakpoint at line 256, then prints the the value of idx and i before crashing.
    ![](media/14974390111680.jpg)

    The length of Buf is buf_len, the value of buf_len is 13868, and the value of msps_len is 13578. Then the value of idx is 13868, so buf will overflow in the next loop. 
    The reason of heap buffer overflow is when special input file satisfies the condition as follow:

    <figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if ((<span class="name">i</span> + <span class="number">1</span>) &lt; msps_len <span class="symbol">&amp;&amp;</span> msps_buf[i] == <span class="number">0</span> <span class="symbol">&amp;&amp;</span> msps_buf[i + <span class="number">1</span>] == <span class="number">0</span>)</div></pre></td></tr></table></figure>

The value of idx will increase by 3, but the value of i only increase by 2. In the PoC file, the position marked by red color can satisfy this condition. Assuming this situation occurs many times, I guess that it will lead to heap buffer overflow.
![](media/14974390386468.jpg)

In order to make bpgdec pass the function build_msps at line 256, in the libbpg.c, we need make the PoC file has a BPG header. And the length field of every region cannot less than zero and cannot equal to 0x80.
The Length Check source code as follow, the constructed input pass the function get_ue32 should return the value which is greater than zero.
![](media/14974390477357.jpg)
</code></pre><h2 id="PoC-file"><a href="#PoC-file" class="headerlink" title="PoC file:"></a>PoC file:</h2><pre><code>![](media/14974390552816.jpg)

And in every region, we need construct many 00 00，in order to satisfy the condition:

<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if ((<span class="name">i</span> + <span class="number">1</span>) &lt; msps_len <span class="symbol">&amp;&amp;</span> msps_buf[i] == <span class="number">0</span> <span class="symbol">&amp;&amp;</span> msps_buf[i + <span class="number">1</span>] == <span class="number">0</span>)</div></pre></td></tr></table></figure>
</code></pre><h2 id="Patch-recommendation"><a href="#Patch-recommendation" class="headerlink" title="Patch recommendation"></a>Patch recommendation</h2><pre><code>In function build_msps.
![](media/14974390986033.jpg)
</code></pre><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><pre><code>One vulnerability exists in libbpg-0.9.7. It exists in the code responsible for decoding BPG image, and missing check the index value of a heap buffer in BPG decoder. In some use cases of bpgdec, it is possible to achieve remote code execution.
</code></pre><h2 id="Author"><a href="#Author" class="headerlink" title="Author"></a>Author</h2><pre><code>name: Meifang, Yang @VARAS of IIE
organization: IIE (http://iie.ac.cn/)
</code></pre></div><script type="text/javascript" src="/MyBlog/js/share.js?v=0.0.0" async></script><a data-url="http://mayfeelyang.github.io/MyBlog/2017/01/14/Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability/" data-id="cj3wx4umn0005yrc0om1i64al" class="article-share-link">分享到</a><div class="tags"><a href="/MyBlog/tags/crash/">crash</a><a href="/MyBlog/tags/heap-buffer-overflow/">heap buffer overflow</a></div><div class="post-nav"><a href="/MyBlog/2017/02/14/Fuzz/sulley的架构/" class="pre">sulley的架构</a><a href="/MyBlog/2017/01/11/PatternRecognition&amp;MachineLearning/几种常见模式识别算法的整理和总结/" class="next">几种常见模式识别算法的整理和总结</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/CTF相关/">CTF相关</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/Preparation-编程基础/">Preparation - 编程基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/模式识别/">模式识别</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/模糊测试/">模糊测试</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/漏洞分析/">漏洞分析</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/MyBlog/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/MyBlog/tags/ELF/" style="font-size: 15px;">ELF</a> <a href="/MyBlog/tags/driller/" style="font-size: 15px;">driller</a> <a href="/MyBlog/tags/symbolic-execution/" style="font-size: 15px;">symbolic execution</a> <a href="/MyBlog/tags/C/" style="font-size: 15px;">C++</a> <a href="/MyBlog/tags/crash/" style="font-size: 15px;">crash</a> <a href="/MyBlog/tags/heap-buffer-overflow/" style="font-size: 15px;">heap buffer overflow</a> <a href="/MyBlog/tags/IDA/" style="font-size: 15px;">IDA</a> <a href="/MyBlog/tags/fuzz/" style="font-size: 15px;">fuzz</a> <a href="/MyBlog/tags/symfuzz/" style="font-size: 15px;">symfuzz</a> <a href="/MyBlog/tags/symbolic-analysis/" style="font-size: 15px;">symbolic analysis</a> <a href="/MyBlog/tags/BAP/" style="font-size: 15px;">BAP</a> <a href="/MyBlog/tags/oss/" style="font-size: 15px;">oss</a> <a href="/MyBlog/tags/zzuf/" style="font-size: 15px;">zzuf</a> <a href="/MyBlog/tags/sulley/" style="font-size: 15px;">sulley</a> <a href="/MyBlog/tags/模式识别/" style="font-size: 15px;">模式识别</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/04/10/zzuf原理及源码分析/">zzuf原理及源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/02/14/Fuzz/sulley的架构/">sulley的架构</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/14/Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability/">Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/11/PatternRecognition&MachineLearning/几种常见模式识别算法的整理和总结/">几种常见模式识别算法的整理和总结</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/23/IDA学习笔记-1/">IDA学习笔记(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/14/OSS-FUZZ相关调研/">OSS-FUZZ相关调研</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/05/Driller-AugmentingFuzzingThroughSelectiveSymbolicExecution-阅读笔记/">Driller:AugmentingFuzzingThroughSelectiveSymbolicExecution-阅读笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/04/markdown使用-马克飞象/">markdown的使用-马克飞象</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/04/symfuzz的实现/">SYMFUZZ的系统实现</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/03/C++类的赋值运算符-的重载、深拷贝、浅拷贝/">C++类的赋值运算符=的重载、深拷贝、浅拷贝</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/MyBlog/." rel="nofollow">菜鸟の日常.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/MyBlog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/MyBlog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/MyBlog/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/MyBlog/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/MyBlog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/MyBlog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/MyBlog/js/smartresize.js?v=0.0.0"></script></div></body></html>