<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录生活点滴"><title>Libbpg-0.9.7 (bpgenc) Null Pointer Dereference | 菜鸟の日常</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/MyBlog/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/MyBlog/favicon.ico"><link rel="apple-touch-icon" href="/MyBlog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/MyBlog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Libbpg-0.9.7 (bpgenc) Null Pointer Dereference</h1><a id="logo" href="/MyBlog/.">菜鸟の日常</a><p class="description">呆到深处自然萌~</p></div><div id="nav-menu"><a href="/MyBlog/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/MyBlog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/MyBlog/about/"><i class="fa fa-user"> 关于</i></a><a href="/MyBlog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Libbpg-0.9.7 (bpgenc) Null Pointer Dereference</h1><div class="post-meta">Jan 30, 2017<span> | </span><span class="category"><a href="/MyBlog/categories/漏洞分析/">漏洞分析</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Overview"><span class="toc-number">1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reproducing"><span class="toc-number">2.</span> <span class="toc-text">Reproducing</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exception"><span class="toc-number">3.</span> <span class="toc-text">Exception</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Analysis"><span class="toc-number">4.</span> <span class="toc-text">Analysis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Patch-recommendation"><span class="toc-number">5.</span> <span class="toc-text">Patch recommendation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-number">6.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Author"><span class="toc-number">7.</span> <span class="toc-text">Author</span></a></li></ol></div></div><div class="post-content"><h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>I have found a vulnerability when I fuzzed libbpg-0.9.7 using the fuzzer which developed by myself. The vulnerability is null pointer dereference due to missing check the return value of function malloc in BPG encoder. The vulnerability happens when converting JPEG format to BPG format. The vulnerability can cause Denial-of-Service (DoS) .<br>Software and Environments<br>Software: libbpg-0.9.7(<a href="http://bellard.org/bpg/" target="_blank" rel="external">http://bellard.org/bpg/</a>)<br>        (download from: <a href="http://bellard.org/bpg/libbpg-0.9.7.tar.gz" target="_blank" rel="external">http://bellard.org/bpg/libbpg-0.9.7.tar.gz</a>)<br>Operating System: Ubuntu 16.04 i686 Desktop<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974413478318.jpg" alt=""></p>
<p>Compilers: gcc<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974413578675.jpg" alt=""></p>
<h1 id="Reproducing"><a href="#Reproducing" class="headerlink" title="Reproducing"></a>Reproducing</h1><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> to <span class="comment">/* path of libbpg source code*/</span></div><div class="line">make –<span class="built_in">j</span></div><div class="line">./bpgenc <span class="comment">/*full path of PoC file*/</span> -o <span class="keyword">out</span></div></pre></td></tr></table></figure>
<h1 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h1><p>Parsing the PoC file with the bpgenc compiled by GCC.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974414005526.jpg" alt=""></p>
<h1 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h1><p>The vulnerability is caused when converting JPEG image to BPG image, which happens in function ../libbpg/bogenc.c: gray8_to_gray(…).<br>Using rr to debug it and printing backtrace infomation.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974414167347.jpg" alt=""></p>
<p>The crash happens at line 255, bpgenc.c, and set a breakpoint at line 255, then prints the the address of y_ptr.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974414292762.jpg" alt=""></p>
<p>y_ptr is delivered by img-&gt;data[idx] + img-&gt;linesize[idx] * y in function read_jpeg. And the address of img-&gt;data is abnormal.<br>Set a breakpoint at line 1405 in the function read_jpeg, and print the value img-&gt;data.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974414397242.jpg" alt=""></p>
<p>The definition of img-&gt;data as follow:<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974414512823.jpg" alt=""></p>
<p>Img-&gt;data initialized at line 1303 in function image_alloc.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974414769807.jpg" alt=""></p>
<p>Set a breakpoint at line 717, and print the value of img-&gt;data[i], the value of w1, h1, img-&gt;pixel_shift and linesize.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974415085689.jpg" alt=""></p>
<p><code>linesize * h1 = 68000 * 56064 = 3812352000( = 3G)</code><br>It is too big to allocate in the heap. So function malloc returns 0x0, represents failure.<br>The value of w1, h1 are related to the cinfo.image_width (w) and cinfo.image_height (h) which can be found in the PoC file.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974415363136.jpg" alt=""></p>
<p>PoC file:<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974415461776.jpg" alt=""></p>
<p>In order to make bpgenc pass the function gray8_to_gray at line 255, we need make cinfo.raw_data_out == false by constructing the JPEG image as follow.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974415583179.jpg" alt=""></p>
<p>We need make comp_hv do not equal to 0x111111, 0x111121 or 0x111122.<br><img src="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/14974415733666.jpg" alt=""></p>
<h1 id="Patch-recommendation"><a href="#Patch-recommendation" class="headerlink" title="Patch recommendation"></a>Patch recommendation</h1><p>In function image_malloc</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>One vulnerability exists in libbpg-0.9.7. It exists in the code responsible for converting JPEG image to BPG image. It is caused by a null pointer dereference.  The vulnerability can cause Denial-of-Service.</p>
<h1 id="Author"><a href="#Author" class="headerlink" title="Author"></a>Author</h1><p>name: Meifang, Yang @VARAS of IIE<br>organization: IIE (<a href="http://iie.ac.cn/" target="_blank" rel="external">http://iie.ac.cn/</a>)</p>
</div><script type="text/javascript" src="/MyBlog/js/share.js?v=0.0.0" async></script><a data-url="http://mayfeelyang.github.io/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/" data-id="cj3xqojxi000hi9c0juagfdkv" class="article-share-link">分享到</a><div class="tags"><a href="/MyBlog/tags/crash/">crash</a><a href="/MyBlog/tags/null-pointer-dereference/">null pointer dereference</a></div><div class="post-nav"><a href="/MyBlog/2017/02/14/Fuzz/sulley的架构/" class="pre">sulley的架构</a><a href="/MyBlog/2017/01/14/Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability/" class="next">Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/CTF相关/">CTF相关</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/Preparation-编程基础/">Preparation - 编程基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/web安全/">web安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/模式识别/">模式识别</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/模糊测试/">模糊测试</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/漏洞分析/">漏洞分析</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/MyBlog/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/MyBlog/tags/C/" style="font-size: 15px;">C++</a> <a href="/MyBlog/tags/fuzz/" style="font-size: 15px;">fuzz</a> <a href="/MyBlog/tags/driller/" style="font-size: 15px;">driller</a> <a href="/MyBlog/tags/symbolic-execution/" style="font-size: 15px;">symbolic execution</a> <a href="/MyBlog/tags/crash/" style="font-size: 15px;">crash</a> <a href="/MyBlog/tags/heap-buffer-overflow/" style="font-size: 15px;">heap buffer overflow</a> <a href="/MyBlog/tags/IDA/" style="font-size: 15px;">IDA</a> <a href="/MyBlog/tags/oss/" style="font-size: 15px;">oss</a> <a href="/MyBlog/tags/null-pointer-dereference/" style="font-size: 15px;">null pointer dereference</a> <a href="/MyBlog/tags/ELF/" style="font-size: 15px;">ELF</a> <a href="/MyBlog/tags/symfuzz/" style="font-size: 15px;">symfuzz</a> <a href="/MyBlog/tags/symbolic-analysis/" style="font-size: 15px;">symbolic analysis</a> <a href="/MyBlog/tags/BAP/" style="font-size: 15px;">BAP</a> <a href="/MyBlog/tags/zzuf/" style="font-size: 15px;">zzuf</a> <a href="/MyBlog/tags/web/" style="font-size: 15px;">web</a> <a href="/MyBlog/tags/xss-csrf/" style="font-size: 15px;">xss - csrf</a> <a href="/MyBlog/tags/sulley/" style="font-size: 15px;">sulley</a> <a href="/MyBlog/tags/模式识别/" style="font-size: 15px;">模式识别</a> <a href="/MyBlog/tags/peach/" style="font-size: 15px;">peach</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/06/14/peach监控/">peach监控</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/06/14/白帽子讲web安全-阅读笔记/">白帽子讲web安全-阅读笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/06/14/Jhead-3-00-Heap-Buffer-Overflow-Vulnerability-2/">Jhead-3.00 Heap Buffer Overflow Vulnerability-2</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/06/01/Jhead-3-00-Heap-Buffer-Overflow-Vulnerability/">Jhead-3.00 Heap Buffer Overflow Vulnerability-1</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/04/10/zzuf原理及源码分析/">zzuf原理及源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/02/14/Fuzz/sulley的架构/">sulley的架构</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/">Libbpg-0.9.7 (bpgenc) Null Pointer Dereference</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/14/Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability/">Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/11/PatternRecognition&MachineLearning/几种常见模式识别算法的整理和总结/">几种常见模式识别算法的整理和总结</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/23/IDA学习笔记-1/">IDA学习笔记(1)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/MyBlog/." rel="nofollow">菜鸟の日常.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/MyBlog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/MyBlog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/MyBlog/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/MyBlog/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/MyBlog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/MyBlog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/MyBlog/js/smartresize.js?v=0.0.0"></script></div></body></html>