<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录生活点滴"><title>zzuf原理及源码分析 | 菜鸟の日常</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/MyBlog/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/MyBlog/favicon.ico"><link rel="apple-touch-icon" href="/MyBlog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/MyBlog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">zzuf原理及源码分析</h1><a id="logo" href="/MyBlog/.">菜鸟の日常</a><p class="description">呆到深处自然萌~</p></div><div id="nav-menu"><a href="/MyBlog/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/MyBlog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/MyBlog/about/"><i class="fa fa-user"> 关于</i></a><a href="/MyBlog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">zzuf原理及源码分析</h1><div class="post-meta">Apr 10, 2017<span> | </span><span class="category"><a href="/MyBlog/categories/模糊测试/">模糊测试</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#zuff简单分析（2017-4-10）"><span class="toc-number">1.</span> <span class="toc-text">zuff简单分析（2017.4.10）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#变异部分主要代码"><span class="toc-number">1.1.</span> <span class="toc-text">变异部分主要代码</span></a></li></ol></li></ol></div></div><div class="post-content"><h1 id="zuff简单分析（2017-4-10）"><a href="#zuff简单分析（2017-4-10）" class="headerlink" title="zuff简单分析（2017.4.10）"></a>zuff简单分析（2017.4.10）</h1><h2 id="变异部分主要代码"><a href="#变异部分主要代码" class="headerlink" title="变异部分主要代码"></a>变异部分主要代码</h2><p>变异部分代码位于： <code>zzuf/src/common/fuzz.c</code> 中。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> _zz_fuzz(<span class="keyword">int</span> fd, <span class="keyword">volatile</span> <span class="keyword">uint8_t</span> *buf, <span class="keyword">int64_t</span> len) <span class="comment">//fd为文件描述符，</span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int64_t</span> pos = _zz_getpos(fd);  <span class="comment">//zzuf中有特定数据结构files，其中包含了以下成员：（int） managed, locked, active, already_fuzzed;  （int64_t） pos, already_pos;   （fuzz_context_t） fuzz。这里的__zz_getpos函数就是取出files结构体中的 pos 属性。pos属性初始化为0（在全部代码中搜索，貌似只有初始化的时候有赋值）。</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined LIBZZUF</span></div><div class="line"></div><div class="line">    debug2(<span class="string">"... fuzz(%i, @%lli, %lli)"</span>, fd, (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)pos,</div><div class="line"></div><div class="line">           (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)len);</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">volatile</span> <span class="keyword">uint8_t</span> *aligned_buf = buf - pos;  <span class="comment">//存储着原始数据, 通过pos校准至原始数据的开头</span></div><div class="line"></div><div class="line">    <span class="keyword">fuzz_context_t</span> *fuzz = _zz_getfuzz(fd);  <span class="comment">// fuzz_context_t结构体包含以下内容： uint32_t seed; double ratio; int64_t cur; (#ifdef HAVE_FGETLN   char *tmp;  #endif); int uflag; int64_t upos;  uint8_t uchar; uint8_t data[CHUNKBYTES]。    其中seed值是按照1、2、3、。。。。进行初始化的，radio是通过seed计算出来的，cur的初始值为-1，uflag为0，*tmp为NULL。</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int64_t</span> i = pos / CHUNKBYTES;</div><div class="line"></div><div class="line">         i &lt; (pos + len + CHUNKBYTES - <span class="number">1</span>) / CHUNKBYTES;</div><div class="line"></div><div class="line">         ++i)</div><div class="line"></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="comment">/* Cache bitmask array */</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (fuzz-&gt;cur != (<span class="keyword">int</span>)i)</div><div class="line"></div><div class="line">        &#123;</div><div class="line"></div><div class="line">            <span class="keyword">uint32_t</span> chunkseed;</div><div class="line">            chunkseed = (<span class="keyword">uint32_t</span>)i;</div><div class="line">            chunkseed ^= MAGIC2;</div><div class="line">            chunkseed += (<span class="keyword">uint32_t</span>)(fuzz-&gt;ratio * MAGIC1);</div><div class="line">            chunkseed ^= fuzz-&gt;seed;</div><div class="line">            chunkseed += (<span class="keyword">uint32_t</span>)(i * MAGIC3);</div><div class="line"></div><div class="line">            zzuf_srand(chunkseed);  <span class="comment">// 设置zzuf自定义的随机种子，使用zzuf_rand的随机种子</span></div><div class="line"></div><div class="line">            <span class="built_in">memset</span>(fuzz-&gt;data, <span class="number">0</span>, CHUNKBYTES);</div><div class="line"></div><div class="line">            <span class="comment">/* Add some random dithering to handle ratio &lt; 1.0/CHUNKBYTES */</span></div><div class="line"></div><div class="line">            <span class="keyword">int</span> todo = (<span class="keyword">int</span>)((fuzz-&gt;ratio * (<span class="number">8</span> * CHUNKBYTES) * <span class="number">1000000.0</span> + zzuf_rand(<span class="number">1000000</span>)) / <span class="number">1000000.0</span>);</div><div class="line"></div><div class="line">            <span class="keyword">while</span> (todo--)</div><div class="line"></div><div class="line">            &#123;</div><div class="line"></div><div class="line">                <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = zzuf_rand(CHUNKBYTES);</div><div class="line"></div><div class="line">                <span class="keyword">uint8_t</span> bit = (<span class="number">1</span> &lt;&lt; zzuf_rand(<span class="number">8</span>));</div><div class="line"></div><div class="line">                fuzz-&gt;data[idx] ^= bit;  <span class="comment">// 使用定义好的随机种子，随机产生fuzz-&gt;data，也就是zzuf中所说的bitmask array</span></div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            fuzz-&gt;cur = i;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* Apply our bitmask array to the buffer */</span></div><div class="line"></div><div class="line">        <span class="keyword">int64_t</span> start = (i * CHUNKBYTES &gt; pos) ? i * CHUNKBYTES : pos;</div><div class="line"></div><div class="line">        <span class="keyword">int64_t</span> stop = ((i + <span class="number">1</span>) * CHUNKBYTES &lt; pos + len) ? (i + <span class="number">1</span>) * CHUNKBYTES : pos + len;   <span class="comment">// 这里的start和stop的意思就是从 数据的pos位置开始的length长度中选择最多CHUNKBYTES的长度</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int64_t</span> j = start; j &lt; stop; ++j)</div><div class="line"></div><div class="line">        &#123;</div><div class="line"></div><div class="line">            <span class="keyword">uint8_t</span> byte, fuzzbyte;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (ranges &amp;&amp; !_zz_isinrange(j, ranges))</div><div class="line"></div><div class="line">                <span class="keyword">continue</span>; <span class="comment">/* Not in one of the ranges, skip byte */</span></div><div class="line"></div><div class="line">            byte = aligned_buf[j];</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (protect[byte])  <span class="comment">// 如果该byte被保护则不进行fuzz</span></div><div class="line"></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">            fuzzbyte = fuzz-&gt;data[j % CHUNKBYTES];</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!fuzzbyte)</div><div class="line"></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (fuzzing)</div><div class="line"></div><div class="line">            &#123;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> FUZZING_XOR:</div><div class="line"></div><div class="line">                byte ^= fuzzbyte;</div><div class="line"></div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> FUZZING_SET:</div><div class="line"></div><div class="line">                byte |= fuzzbyte;</div><div class="line"></div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> FUZZING_UNSET:</div><div class="line"></div><div class="line">                byte &amp;= ~fuzzbyte;</div><div class="line"></div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (refuse[byte])</div><div class="line"></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">            aligned_buf[j] = byte;  <span class="comment">// 修改原始数据的值</span></div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* Handle ungetc() */</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (fuzz-&gt;uflag)</div><div class="line"></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        fuzz-&gt;uflag = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (fuzz-&gt;upos == pos)</div><div class="line"></div><div class="line">            buf[<span class="number">0</span>] = fuzz-&gt;uchar;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/MyBlog/js/share.js?v=0.0.0" async></script><a data-url="http://mayfeelyang.github.io/MyBlog/2017/04/10/zzuf原理及源码分析/" data-id="cj1bxqrpi000jybc0ax1zknw7" class="article-share-link">分享到</a><div class="tags"><a href="/MyBlog/tags/fuzz/">fuzz</a><a href="/MyBlog/tags/zzuf/">zzuf</a></div><div class="post-nav"><a href="/MyBlog/2017/02/14/Fuzz/sulley的架构/" class="next">sulley的架构</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/CTF相关/">CTF相关</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/Preparation-编程基础/">Preparation - 编程基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/模式识别/">模式识别</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/模糊测试/">模糊测试</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/MyBlog/tags/zzuf/" style="font-size: 15px;">zzuf</a> <a href="/MyBlog/tags/fuzz/" style="font-size: 15px;">fuzz</a> <a href="/MyBlog/tags/symbolic-execution/" style="font-size: 15px;">symbolic execution</a> <a href="/MyBlog/tags/C/" style="font-size: 15px;">C++</a> <a href="/MyBlog/tags/ELF/" style="font-size: 15px;">ELF</a> <a href="/MyBlog/tags/IDA/" style="font-size: 15px;">IDA</a> <a href="/MyBlog/tags/oss/" style="font-size: 15px;">oss</a> <a href="/MyBlog/tags/driller/" style="font-size: 15px;">driller</a> <a href="/MyBlog/tags/symfuzz/" style="font-size: 15px;">symfuzz</a> <a href="/MyBlog/tags/symbolic-analysis/" style="font-size: 15px;">symbolic analysis</a> <a href="/MyBlog/tags/BAP/" style="font-size: 15px;">BAP</a> <a href="/MyBlog/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/MyBlog/tags/sulley/" style="font-size: 15px;">sulley</a> <a href="/MyBlog/tags/模式识别/" style="font-size: 15px;">模式识别</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/04/10/zzuf原理及源码分析/">zzuf原理及源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/02/14/Fuzz/sulley的架构/">sulley的架构</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/11/PatternRecognition&MachineLearning/几种常见模式识别算法的整理和总结/">几种常见模式识别算法的整理和总结</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/23/IDA学习笔记-1/">IDA学习笔记(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/14/OSS-FUZZ相关调研/">OSS-FUZZ相关调研</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/05/Driller-AugmentingFuzzingThroughSelectiveSymbolicExecution-阅读笔记/">Driller:AugmentingFuzzingThroughSelectiveSymbolicExecution-阅读笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/04/markdown使用-马克飞象/">markdown的使用-马克飞象</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/04/symfuzz的实现/">SYMFUZZ的系统实现</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/03/C++类的赋值运算符-的重载、深拷贝、浅拷贝/">C++类的赋值运算符=的重载、深拷贝、浅拷贝</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/02/ELF动态装载123/">ELF动态装载123</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/MyBlog/." rel="nofollow">菜鸟の日常.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/MyBlog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/MyBlog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/MyBlog/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/MyBlog/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/MyBlog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/MyBlog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/MyBlog/js/smartresize.js?v=0.0.0"></script></div></body></html>