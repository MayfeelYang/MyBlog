<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录生活点滴"><title>Jhead-3.00 Heap Buffer Overflow Vulnerability-2 | 菜鸟の日常</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/MyBlog/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/MyBlog/favicon.ico"><link rel="apple-touch-icon" href="/MyBlog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/MyBlog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Jhead-3.00 Heap Buffer Overflow Vulnerability-2</h1><a id="logo" href="/MyBlog/.">菜鸟の日常</a><p class="description">呆到深处自然萌~</p></div><div id="nav-menu"><a href="/MyBlog/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/MyBlog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/MyBlog/about/"><i class="fa fa-user"> 关于</i></a><a href="/MyBlog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Jhead-3.00 Heap Buffer Overflow Vulnerability-2</h1><div class="post-meta">Jun 14, 2017<span> | </span><span class="category"><a href="/MyBlog/categories/漏洞分析/">漏洞分析</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Overview"><span class="toc-number">1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Testing-Environment"><span class="toc-number">2.</span> <span class="toc-text">Testing Environment:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#stack-back-trace"><span class="toc-number">3.</span> <span class="toc-text">stack back trace:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#vulnerability-cause-analysis"><span class="toc-number">4.</span> <span class="toc-text">vulnerability cause analysis:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Patch-recommendation"><span class="toc-number">5.</span> <span class="toc-text">Patch recommendation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reproduce"><span class="toc-number">6.</span> <span class="toc-text">Reproduce</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Author"><span class="toc-number">7.</span> <span class="toc-text">Author</span></a></li></ol></div></div><div class="post-content"><h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>The vulnerability is a heap buffer overflow due to missing to check the index value of a heap buffer in jpgqguess.c. And it maybe cause Information Disclosure.</p>
<h1 id="Testing-Environment"><a href="#Testing-Environment" class="headerlink" title="Testing Environment:"></a>Testing Environment:</h1><p>Ubuntu(16.04 64bit) + jhead(3.00) + gcc (5.4.0)<br>(jhead: <a href="http://www.sentex.net/~mwandel/jhead/" target="_blank" rel="external">http://www.sentex.net/~mwandel/jhead/</a>)</p>
<h1 id="stack-back-trace"><a href="#stack-back-trace" class="headerlink" title="stack back trace:"></a>stack back trace:</h1><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#0</span> <span class="selector-tag">0x500ca9</span> <span class="selector-tag">in</span> <span class="selector-tag">process_DQT</span> /<span class="selector-tag">home</span>/<span class="selector-tag">root2</span>/<span class="selector-tag">MyFuzzerTarget</span>/<span class="selector-tag">jhead-3</span><span class="selector-class">.00</span>/<span class="selector-tag">jpgqguess</span><span class="selector-class">.c</span><span class="selector-pseudo">:112</span><span class="selector-pseudo">:36</span></div><div class="line"><span class="selector-id">#1</span> <span class="selector-tag">0x4fb8e4</span> <span class="selector-tag">in</span> <span class="selector-tag">ReadJpegSections</span> /<span class="selector-tag">home</span>/<span class="selector-tag">root2</span>/<span class="selector-tag">MyFuzzerTarget</span>/<span class="selector-tag">jhead-3</span><span class="selector-class">.00</span>/<span class="selector-tag">jpgfile</span><span class="selector-class">.c</span><span class="selector-pseudo">:223</span><span class="selector-pseudo">:17</span></div><div class="line"><span class="selector-id">#2</span> <span class="selector-tag">0x4fd730</span> <span class="selector-tag">in</span> <span class="selector-tag">ReadJpegFile</span> /<span class="selector-tag">home</span>/<span class="selector-tag">root2</span>/<span class="selector-tag">MyFuzzerTarget</span>/<span class="selector-tag">jhead-3</span><span class="selector-class">.00</span>/<span class="selector-tag">jpgfile</span><span class="selector-class">.c</span><span class="selector-pseudo">:375</span><span class="selector-pseudo">:11</span></div><div class="line"><span class="selector-id">#3</span> <span class="selector-tag">0x4f4ecf</span> <span class="selector-tag">in</span> <span class="selector-tag">ProcessFile</span> /<span class="selector-tag">home</span>/<span class="selector-tag">root2</span>/<span class="selector-tag">MyFuzzerTarget</span>/<span class="selector-tag">jhead-3</span><span class="selector-class">.00</span>/<span class="selector-tag">jhead</span><span class="selector-class">.c</span><span class="selector-pseudo">:896</span><span class="selector-pseudo">:10</span></div><div class="line"><span class="selector-id">#4</span> <span class="selector-tag">0x4f3ccb</span> <span class="selector-tag">in</span> <span class="selector-tag">main</span> /<span class="selector-tag">home</span>/<span class="selector-tag">root2</span>/<span class="selector-tag">MyFuzzerTarget</span>/<span class="selector-tag">jhead-3</span><span class="selector-class">.00</span>/<span class="selector-tag">jhead</span><span class="selector-class">.c</span><span class="selector-pseudo">:1730</span><span class="selector-pseudo">:13</span></div><div class="line"><span class="selector-id">#5</span> <span class="selector-tag">0x7fa846c4c82f</span> <span class="selector-tag">in</span> <span class="selector-tag">__libc_start_main</span> /<span class="selector-tag">build</span>/<span class="selector-tag">glibc-9tT8Do</span>/<span class="selector-tag">glibc-2</span><span class="selector-class">.23</span>/<span class="selector-tag">csu</span>/../<span class="selector-tag">csu</span>/<span class="selector-tag">libc-start</span><span class="selector-class">.c</span><span class="selector-pseudo">:291</span></div><div class="line"> <span class="selector-id">#6</span> <span class="selector-tag">0x419ad8</span> <span class="selector-tag">in</span> <span class="selector-tag">_start</span> (/home/root2/MyFuzzerTarget/jhead-<span class="number">3.00</span>/jhead+<span class="number">0</span>x419ad8)</div></pre></td></tr></table></figure>
<h1 id="vulnerability-cause-analysis"><a href="#vulnerability-cause-analysis" class="headerlink" title="vulnerability cause analysis:"></a>vulnerability cause analysis:</h1><p>There are two loops at function process_DQT() in jpgqguess.c. “a”is a index variable of heap buffer and is initialized to 2. When “a”less than “length”, the outer loop can continue. But in inner loop, it will read from index “a”to index “a + 63“. When the variable “length”which read from input file less than 66, it will cause heap buffer overflow.</p>
<h1 id="Patch-recommendation"><a href="#Patch-recommendation" class="headerlink" title="Patch recommendation"></a>Patch recommendation</h1><p>Added at jpgqguess.c: 105 (added at the inner loop)<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="comment">(a &gt;= length)</span></div><div class="line">	break;</div></pre></td></tr></table></figure></p>
<h1 id="Reproduce"><a href="#Reproduce" class="headerlink" title="Reproduce"></a>Reproduce</h1><p>./jhead PoC</p>
<h1 id="Author"><a href="#Author" class="headerlink" title="Author"></a>Author</h1><p>Name: Meifang, Yang @ VARAS of IIE</p>
</div><script type="text/javascript" src="/MyBlog/js/share.js?v=0.0.0" async></script><a data-url="http://mayfeelyang.github.io/MyBlog/2017/06/14/Jhead-3-00-Heap-Buffer-Overflow-Vulnerability-2/" data-id="cj3xqojx1000ai9c0ehjc7fbf" class="article-share-link">分享到</a><div class="tags"><a href="/MyBlog/tags/crash/">crash</a><a href="/MyBlog/tags/heap-buffer-overflow/">heap buffer overflow</a></div><div class="post-nav"><a href="/MyBlog/2017/06/14/白帽子讲web安全-阅读笔记/" class="pre">白帽子讲web安全-阅读笔记</a><a href="/MyBlog/2017/06/01/Jhead-3-00-Heap-Buffer-Overflow-Vulnerability/" class="next">Jhead-3.00 Heap Buffer Overflow Vulnerability-1</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/CTF相关/">CTF相关</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/Preparation-编程基础/">Preparation - 编程基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/web安全/">web安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/模式识别/">模式识别</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/模糊测试/">模糊测试</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/MyBlog/categories/漏洞分析/">漏洞分析</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/MyBlog/tags/null-pointer-dereference/" style="font-size: 15px;">null pointer dereference</a> <a href="/MyBlog/tags/C/" style="font-size: 15px;">C++</a> <a href="/MyBlog/tags/fuzz/" style="font-size: 15px;">fuzz</a> <a href="/MyBlog/tags/driller/" style="font-size: 15px;">driller</a> <a href="/MyBlog/tags/symbolic-execution/" style="font-size: 15px;">symbolic execution</a> <a href="/MyBlog/tags/crash/" style="font-size: 15px;">crash</a> <a href="/MyBlog/tags/heap-buffer-overflow/" style="font-size: 15px;">heap buffer overflow</a> <a href="/MyBlog/tags/IDA/" style="font-size: 15px;">IDA</a> <a href="/MyBlog/tags/oss/" style="font-size: 15px;">oss</a> <a href="/MyBlog/tags/ELF/" style="font-size: 15px;">ELF</a> <a href="/MyBlog/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/MyBlog/tags/symfuzz/" style="font-size: 15px;">symfuzz</a> <a href="/MyBlog/tags/symbolic-analysis/" style="font-size: 15px;">symbolic analysis</a> <a href="/MyBlog/tags/BAP/" style="font-size: 15px;">BAP</a> <a href="/MyBlog/tags/zzuf/" style="font-size: 15px;">zzuf</a> <a href="/MyBlog/tags/web/" style="font-size: 15px;">web</a> <a href="/MyBlog/tags/xss-csrf/" style="font-size: 15px;">xss - csrf</a> <a href="/MyBlog/tags/sulley/" style="font-size: 15px;">sulley</a> <a href="/MyBlog/tags/模式识别/" style="font-size: 15px;">模式识别</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/06/14/peach监控/">peach监控</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/06/14/白帽子讲web安全-阅读笔记/">白帽子讲web安全-阅读笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/06/14/Jhead-3-00-Heap-Buffer-Overflow-Vulnerability-2/">Jhead-3.00 Heap Buffer Overflow Vulnerability-2</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/06/01/Jhead-3-00-Heap-Buffer-Overflow-Vulnerability/">Jhead-3.00 Heap Buffer Overflow Vulnerability-1</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/04/10/zzuf原理及源码分析/">zzuf原理及源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/02/14/Fuzz/sulley的架构/">sulley的架构</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/30/Libbpg-0-9-7-bpgenc-Null-Pointer-Dereference/">Libbpg-0.9.7 (bpgenc) Null Pointer Dereference</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/14/Libbpg-0-9-7-bpgdec-Heap-Buffer-Overflow-Vulnerability/">Libbpg-0.9.7 (bpgdec) Heap Buffer Overflow Vulnerability</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2017/01/11/PatternRecognition&MachineLearning/几种常见模式识别算法的整理和总结/">几种常见模式识别算法的整理和总结</a></li><li class="post-list-item"><a class="post-list-link" href="/MyBlog/2016/12/23/IDA学习笔记-1/">IDA学习笔记(1)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/MyBlog/." rel="nofollow">菜鸟の日常.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/MyBlog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/MyBlog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/MyBlog/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/MyBlog/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/MyBlog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/MyBlog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/MyBlog/js/smartresize.js?v=0.0.0"></script></div></body></html>